(()=>{"use strict";class e{constructor(e,t,s){this.slideIds={500:"homelands",600:"pathways1",700:"pathways2",800:"villagerssettlers",900:"lines"},this.L=t,this.d3=s,this.homelandsSlide=null,this.pathways1Slide=null,this.pathways2Slide=null,this.villagerssettlersSlide=null,this.linesSlide=[],this.svgDrawn=!1,this.introRunning=!1,this.geometryUris=e,this.startingBounds={homelands:{type:"Feature",properties:{id:null,FID:12,Narr_ID:1,Seq_ID:90,Desc:"Extent of Indigenous references in 12 Mitchell"},geometry:{type:"MultiPolygon",coordinates:[[[[-60.37551705595166,50.4951555420448],[-60.31189218529776,27.407898583362975],[-109.07132113730609,27.405734834799336],[-108.82778202129992,50.54606747098813],[-60.37551705595166,50.4951555420448]]]]}},pathways1:{type:"Feature",properties:{id:null,FID:15,Narr_ID:null,Seq_ID:null,Desc:"smaller_continental"},geometry:{type:"MultiPolygon",coordinates:[[[[-64.95605152334238,48.69329204368009],[-65.11062944404395,28.186892930726643],[-104.22843984756395,28.29902204928944],[-104.14627755699446,48.59814245312983],[-64.95605152334238,48.69329204368009]]]]}},pathways2:{type:"Feature",properties:{id:null,FID:10,Narr_ID:1,Seq_ID:50,Desc:"Chesapeake Bay area"},geometry:{type:"MultiPolygon",coordinates:[[[[-80.00247983922968,40.16844118288532],[-71.78812858656173,40.17858098804808],[-71.80139894399737,37.05857933377866],[-80.029020554101,37.07975639320331],[-80.00247983922968,40.16844118288532]]]]}},villagerssettlers:{type:"Feature",properties:{id:null,FID:12,Narr_ID:1,Seq_ID:90,Desc:"Extent of Indigenous references in 12 Mitchell"},geometry:{type:"MultiPolygon",coordinates:[[[[-60.37551705595166,50.4951555420448],[-60.31189218529776,27.407898583362975],[-109.07132113730609,27.405734834799336],[-108.82778202129992,50.54606747098813],[-60.37551705595166,50.4951555420448]]]]}},lines:{type:"Feature",properties:{id:null,FID:11,Narr_ID:1,Seq_ID:80,Desc:"Haudenosaunee homelands"},geometry:{type:"MultiPolygon",coordinates:[[[[-85.11820263067318,47.60401023213455],[-69.19377370789199,47.639788180258115],[-69.06107013353548,39.89409408509995],[-85.11820263067318,39.9144539263869],[-85.11820263067318,47.60401023213455]]]]}}}}sleep(e){return new Promise((t=>setTimeout(t,e)))}disableMapMovement(e){e.zoomControl.disable(),e.dragging.disable()}enableMapMovement(e){e.zoomControl.enable(),e.dragging.enable()}stopAll(){this.introRunning=!1,this.svg.selectAll("*").interrupt()}clearSvg(){this.svg.selectAll("*").remove(),this.svgDrawn=!1}async SectionIntro(e,t){if(this.slideIds[t+""]){let s=!1;switch(this.introRunning=!0,console.log(this.svgDrawn),this.svgDrawn&&(this.stopAll(),this.clearSvg()),this.slideIds[t+""]){case"homelands":console.log("homelands"),s=await this.playHomelandsIntro(e);break;case"pathways1":console.log("pathways1"),s=await this.playPathways1Intro(e);break;case"pathways2":console.log("pathways2"),s=await this.playPathways2Intro(e);break;case"villagerssettlers":console.log("settlers"),s=await this.playvillagerssettlersSlide(e);break;case"lines":console.log("lines"),s=await this.playLinesIntro(e)}this.svgDrawn=s}return this.svgDrawn}async loadShapeFile(e){let t=await fetch(e);return await t.json()}async loadD3(e){this.L.svg({clickable:!0}).addTo(e);const t=this.d3.select(e.getPanes().overlayPane);return this.svg=t.select("svg").attr("pointer-events","auto"),this.featureLineGenerator=this.d3.line().x((t=>e.latLngToLayerPoint([t[1],t[0]]).x)).y((t=>e.latLngToLayerPoint([t[1],t[0]]).y)),this.svg}featureToPath(e){let t="";switch(e.geometry.type){case"MultiPolygon":t=this.featureLineGenerator(e.geometry.coordinates[0][0]);break;case"MultiLineString":t=this.featureLineGenerator(e.geometry.coordinates[0])}return t}async drawHomelandsIntro(e,t){this.svg.selectAll(".homelands").data(t).join("path").attr("class","homelands").attr("title",(e=>e.properties.norm_text)).attr("stroke","black").attr("fill","none").attr("stroke-width","0").attr("d",(e=>this.featureToPath(e))),this.svg.selectAll(".homelands").each(((e,t,s)=>{const i=this.d3.select(s[t]).node().getBBox(),l=i.x+i.width/2,r=i.y+i.height/2;this.svg.append("text").text(e.properties.norm_text).attr("x",l).attr("y",r).attr("fill","#0804ee").attr("text-anchor","middle")}))}async playHomelandsIntro(e){return this.homelandsLabels||(this.homelandsLabels=await this.loadShapeFile(this.geometryUris.homelands)),this.homelandsSlide?(e.flyToBounds(this.L.geoJson(this.startingBounds.homelands).getBounds()),await this.sleep(500),await this.drawHomelandsIntro(e,this.homelandsSlide.features)):console.log("homelands slide not present!"),!0}async playPathways1Intro(e){return e.flyToBounds(this.L.geoJson(this.startingBounds.pathways1).getBounds()),await this.sleep(1500),this.pathways1Slide&&this.pathways1Slide.features.length>0&&(this.svg.selectAll(".river").data(this.pathways1Slide.features).join("path").attr("class","pathways1 river").attr("stroke","blue").attr("fill","none").attr("stroke-width","1.5").attr("d",(e=>this.featureToPath(e))),await this.svg.selectAll("path.river").each((function(e){e.totalLength=this.getTotalLength()})).attr("stroke-dashoffset",(e=>e.totalLength)).attr("stroke-dasharray",(e=>e.totalLength)).transition().duration(2500).attr("stroke-dashoffset",0).end()),!0}static splitFeatures(e){let t={points:[],polys:[],lines:[]};for(let s in e)if(e[s].geometry&&e[s].geometry.type)switch(e[s].geometry.type){case"MultiPolygon":t.polys.push(e[s]);break;case"MultiLineString":t.lines.push(e[s]);break;case"Point":t.points.push(e[s])}return t}async playPathways2Intro(t){if(t.flyToBounds(this.L.geoJson(this.startingBounds.pathways2).getBounds()),await this.sleep(1500),!this.pathways2Slide||0==this.pathways2Slide.features.length)return!1;let s=e.splitFeatures(this.pathways2Slide.features);return s.lines&&s.lines.length>0&&(this.svg.selectAll(".road").data(this.pathways1Slide.features).join("path").attr("class","pathways2 road").attr("stroke","brown").attr("fill","none").attr("stroke-width","1").attr("d",(e=>this.featureToPath(e))),await this.svg.selectAll("path.road").each((function(e){e.totalLength=this.getTotalLength()})).attr("stroke-dashoffset",(e=>e.totalLength)).attr("stroke-dasharray",(e=>e.totalLength)).transition().duration(2500).attr("stroke-dashoffset",0).end()),s.points&&s.points.length>0&&this.svg.selectAll("circle.pathways2").data(s.points).join("circle").attr("class","pathways2 dipsites").attr("fill","red").attr("stroke","black").attr("cx",(e=>t.latLngToLayerPoint([e.geometry.coordinates[1],e.geometry.coordinates[0]]).x)).attr("cy",(e=>t.latLngToLayerPoint([e.geometry.coordinates[1],e.geometry.coordinates[0]]).y)).attr("r",20).transition().attr("r",5).duration(1e3).end(),!0}async playvillagerssettlersSlide(t){if(t.flyToBounds(this.L.geoJson(this.startingBounds.villagerssettlers).getBounds()),await this.sleep(1500),!this.villagerssettlersSlide||0==this.villagerssettlersSlide.features.length)return!1;let s=e.splitFeatures(this.villagerssettlersSlide.features);await this.svg.selectAll("circle.villagerssettlers").data(s.points).join("circle").attr("class","villagerssettlers").attr("fill",(function(e){return e.properties&&12==e.properties.sub_type?"red":"green"})).attr("cx",(e=>t.latLngToLayerPoint([e.geometry.coordinates[1],e.geometry.coordinates[0]]).x)).attr("cy",(e=>t.latLngToLayerPoint([e.geometry.coordinates[1],e.geometry.coordinates[0]]).y)).attr("r",20).transition().attr("r",3).duration(1e3).end();let i=[];for(let e=0;e<s.points.length;e++){let t=s.points[e];t.properties&&t.properties.sub_type&&12==t.properties.sub_type&&i.push(t)}let l="circle.villagerssettlers.pulse";return this.svg.selectAll(l).data(i).join("circle").attr("class","villagerssettlers pulse").attr("fill","black").attr("opacity","0.5").attr("cx",(e=>t.latLngToLayerPoint([e.geometry.coordinates[1],e.geometry.coordinates[0]]).x)).attr("cy",(e=>t.latLngToLayerPoint([e.geometry.coordinates[1],e.geometry.coordinates[0]]).y)).attr("r",3),this.pulseTransition(l),!0}async pulseTransition(e){for(;this.introRunning;)await this.svg.selectAll(e).attr("r",3).attr("opacity","0").attr("fill","black").transition().duration(1e3).attr("r",10).attr("opacity","0.5").styleTween("fill",(()=>this.d3.interpolateRgb("black","red"))).transition().duration(500).attr("opacity","0").end();return!0}async drawLines(e,t,s,i,l){return this.svg.selectAll("."+l).data(e).join("path").attr("class",i+" "+l).attr("stroke",s).attr("fill","none").attr("stroke-width","1").attr("d",(e=>this.featureToPath(e))),this.svg.selectAll("path."+l).each((function(e){e.totalLength=this.getTotalLength()})).attr("stroke-dashoffset",(e=>e.totalLength)).attr("stroke-dasharray",(e=>e.totalLength)).transition().duration(t).attr("stroke-dashoffset",0).end()}async playLinesIntro(e){if(e.flyToBounds(this.L.geoJson(this.startingBounds.lines).getBounds()),this.linesSlide&&this.linesSlide.length>0)for(let e=0;e<this.linesSlide.length;e++)await this.drawLines(this.linesSlide[e].features,2500,"red","lines","border"),await this.sleep(1e3);return!0}}new class{constructor(e,t,s){this.overlay=null,this.storyUris=e,this.map=null,this.L=t,this.d3=s,this.layerGroups={},this.storyFrames=[],this.featureTypes=["points","lines","polys"],this.mapMinZoom=1,this.mapMaxZoom=11,this.slideElementTagName="article",this.topSlideElement=null,this.highlightLineStyle={stroke:!0,color:"#0000ff",weight:5,opacity:1},this.defaultLineStyle={stroke:!0,color:"#ff0000",fillColor:"#ff0000",weight:2,opacity:.6,fill:!0},this.slides={},this.lastSlideDisplayed=null,this.slideElements={},this.allFeatures=[],this.allFeaturesLayer=null,this.textFeatures={},this.textMinZoomLevel=8,this.defaultTextAttributes={fill:"black","font-family":"EB Garamond, serif","font-weight":"bold",dx:"15%"},this.initStyles(),this.mapLookup={1:"White, 1590",2:"Bleau, 1650",3:"Seller, 1676",4:"n/a",5:"Foster, 1677",6:"Moll, 1720",7:"Burghers, 1738",8:"Evans, 1752",9:"n/a",10:"Herbert, 1755",11:"Moll, 1755",12:"Mitchell, 1755",13:"Bowen, 1772",14:"Jeffreys, 1774",15:"Hutchins, 1778",16:"Cary,  1783",17:"Buell, 1784",18:"Russell, 1794",19:"Bradley, 1796"},this.exploreFilterControl={id:0,fid:0,sub_type:[[],[],[],[],[],[],[],[],[],[],[],[],[],[]],maps:[],features:[],lines:{includes:{},excludes:{}},points:{includes:{},excludes:{}},polys:{includes:{},excludes:{}},excludes:{}},this.exploreSelectors={explore_filter:"input.explore_filter",map_filter:"input.map_selector",explore_counter:"totalExploreFiltersApplied",map_counter:"totalMapFiltersApplied",selectall_maps:"selectallMaps",selectall_features:"selectallFeatures"},this.totalExploreFilters=7,this.totalExploreFiltersApplied=0,this.totalMapFilters=17,this.totalMapFiltersApplied=0,this.exploreFeatureSubtypes=[10,4,12,13,3,12],this.exploreFeatures=[],this.initExploreFilters()}initStyles(){this.lineBorderStyle={stroke:!0,dashArray:"3 6",lineCap:"square",color:"#000000",weight:2.5,fill:!1},this.lineLandRouteStyle={stroke:!0,dashArray:"7 6",lineCap:"square",lineJoin:"arcs",color:"#808080",weight:3,fill:!1},this.lineSeaRouteStyle={stroke:!0,dashArray:"7 6",lineCap:"square",lineJoin:"arcs",color:"#ffbd59",weight:3,fill:!1},this.lineRiverRouteStyle={stroke:!0,color:"#2D9BF0",lineCap:"square",lineJoin:"round",weight:2,fill:!1,opacity:.5},this.lineRiverRouteStyleLabel={stroke:!0,smoothFactor:15,dashArray:"7 9",color:"#000000FF",lineCap:"square",lineJoin:"round",weight:2,fill:!1},this.lineMiscStyle={stroke:!0,color:"#ffff00",weight:4,fill:!1},this.lineToponymStyle={stroke:!0,color:"#ff0000",weight:5,fill:!1},this.polyBorderStyle={stroke:!0,dashArray:"4 6",color:"#000000",fillColor:"#000000",lineCap:"square",weight:2,fill:!0,opacity:.5,fillOpacity:.25},this.polySettlementStyle={stroke:!0,dashArray:"2 6",lineCap:"square",lineJoin:"arcs",color:"#ff0000",fillColor:"#ff0000",weight:2,fill:!0,opacity:.75,fillOpacity:.5},this.polySeaRouteStyle={stroke:!0,dashArray:"7 6",lineCap:"square",lineJoin:"arcs",color:"#ffbd59",fillColor:"#ffbd59",weight:2,fill:!0,opacity:.75,fillOpacity:.5},this.polyDescriptiveStyle={stroke:!0,fillColor:"#ff0000",weight:1,fill:!0,opacity:.5,fillOpacity:.5},this.polyRiverRouteStyle={stroke:!0,dashArray:"7 6",lineCap:"square",lineJoin:"arcs",color:"#00c2cb",fillColor:"#00c2cb",weight:2,fill:!0,opacity:.75,fillOpacity:.5},this.polyMiscStyle={stroke:!0,fillColor:"#ff0000",weight:1,fill:!0,opacity:.5,fillOpacity:.5},this.polyNativeStyle={stroke:!0,fillColor:"#ff0000",weight:1,fill:!0,opacity:.5,fillOpacity:.5},this.polyEuroStyle={stroke:!0,fillColor:"#00ff00",weight:1,fill:!0,opacity:.5,fillOpacity:.5},this.polyAnnoStyle={stroke:!0,dashArray:"10 10",lineCap:"square",lineJoin:"arcs",color:"#808080",fillColor:"#808080",weight:1,fill:!0,opacity:1,fillOpacity:.5},this.polyToponymStyle={stroke:!0,dashArray:"7 6",lineCap:"square",lineJoin:"arcs",color:"#ff0000",fillColor:"#ff0000",weight:1,fill:!0,opacity:.5,fillOpacity:.5}}async loadShapeFile(e){let t=await fetch(e);return await t.json()}async loadShapes(e){let t=[],s=[],i=[];for(let s=0;s<e.length;s++)t.push(this.loadShapeFile(e[s]));await Promise.all(t).then((e=>{for(let t=0;t<e.length;t++)s.push(...e[t].features)}));for(let e=0;e<s.length;e++){let t=s[e];t.properties&&(this.allFeatures.push(t),i.push(t))}return i}async loadSlides(){if(this.storyUris&&this.storyUris.slides){let e=await this.loadShapeFile(this.storyUris.slides);this.slides=e.slides}}getSlideById(e){for(let t=0;t<this.slides.length;t++)if(this.slides[t].id==e)return this.slides[t];console.log("Warning! slide "+e+" not found")}pointToLayer(e,t){switch(e.properties.sub_type){case 1:return this.L.circleMarker(t,{radius:4,fillColor:"#7A0707",color:"#7A0707",weight:.5,opacity:1,fillOpacity:1,bubblingMouseEvents:!0});case 4:return 1===e.properties.identity?new this.L.RegularPolygonMarker(t,{numberOfSides:4,rotation:-45,radius:6,fill:!0,fillColor:"#7A0707",color:"#7A0707",weight:.5,fillOpacity:1,stroke:!0,bubblingMouseEvents:!0}):this.L.circleMarker(t,{radius:5,fillColor:"#7A0707",color:"#7A0707",weight:.5,opacity:1,fillOpacity:1,bubblingMouseEvents:!0});case 5:return this.L.circleMarker(t,{radius:4,fillColor:"#0000ff",color:"#000",weight:.5,opacity:1,fillOpacity:1,bubblingMouseEvents:!0});case 6:return this.L.circleMarker(t,{radius:4,fillColor:"#ffbd59",color:"#ffbd59",weight:.5,opacity:1,fillOpacity:.9,bubblingMouseEvents:!0});case 7:return new this.L.RegularPolygonMarker(t,{numberOfSides:4,rotation:-45,radius:5,fill:!0,fillColor:"#ffffff",color:"#000000",weight:.5,fillOpacity:1,stroke:!0,bubblingMouseEvents:!0});case 8:return this.L.circleMarker(t,{radius:4,fillColor:"#ff00ff",color:"#000",weight:.5,opacity:1,fillOpacity:1,bubblingMouseEvents:!0});case 9:return this.L.circleMarker(t,{radius:4,fillColor:"#000000",color:"#000",weight:.5,opacity:1,fillOpacity:1,bubblingMouseEvents:!0});case 10:return 1===e.properties.identity?new this.L.RegularPolygonMarker(t,{numberOfSides:4,rotation:-45,radius:7,fill:!0,fillColor:"#FFFFFF",color:"#48A795",weight:2.5,fillOpacity:1,stroke:!0,bubblingMouseEvents:!0}):this.L.circleMarker(t,{radius:6,fillColor:"#FFFFFF",color:"#48A795",weight:2.5,opacity:1,fillOpacity:1,bubblingMouseEvents:!0});default:return this.L.circleMarker(t,{radius:4,fillColor:"#000ff",color:"#0000ff",weight:.5,opacity:1,fillOpacity:1,bubblingMouseEvents:!0})}}initStoryFeatureLayers(){for(let e=0;e<this.slides.length;e++){let t=this.slides[e];t.layer=this.L.geoJSON(t.features,{pointToLayer:this.pointToLayer.bind(this),onEachFeature:this.onEachFeature.bind(this)})}}initAllFeaturesLayer(){this.allFeaturesLayer=this.L.geoJSON(this.allFeatures,{pointToLayer:this.pointToLayer.bind(this),onEachFeature:this.onEachFeature.bind(this)})}getSlideElements(){this.slideElements=Array.from(document.getElementsByTagName(this.slideElementTagName)),this.slideElements.sort((function(e,t){return e.offsetTop<0?1:t.offsetTop<0?-1:e.offsetTop-t.offsetTop}))}fadeLayerLeaflet(e,t,s,i,l){let r=t;setTimeout((function t(){r<s&&(e.setStyle({opacity:r,fillOpacity:r}),r+=i),setTimeout(t,l)}),l)}async triggerSlideMapEvents(e){if(console.log(e),this.d3Intro.slideIds[e+""])this.storyFeatureLayerGroup.clearLayers(),this.d3Intro.SectionIntro(this.map,e,this.slides);else if("explore"!=e){this.d3Intro.svgDrawn&&(this.d3Intro.stopAll(),this.d3Intro.clearSvg());let t=this.getSlideById(e);if(t){if(this.clearFeatureText(),t.layer&&this.storyFeatureLayerGroup.clearLayers(),this.map.flyToBounds(this.getStoryFrameBounds(t.fid)),t.layer){let e=function(){t.layer.setStyle({opacity:0,fillOpacity:0}),this.storyFeatureLayerGroup.addLayer(t.layer),this.fadeLayerLeaflet(t.layer,0,1,.2,.01),this.map.off("moveend",e)}.bind(this);this.map.on("moveend",e)}this.lastSlideDisplayed=t}}else"explore"==e&&(this.storyFeatureLayerGroup.clearLayers(),this.loadExploreLayer())}async initMap(t,s,i){this.map=this.L.map("basemap",{scrollWheelZoom:!1,zoomControl:!1}),this.L.control.zoom({position:"bottomleft"}).addTo(this.map),this.overlay=this.L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",{minZoom:this.mapMinZoom,maxZoom:this.mapMaxZoom,attribution:"ESRI World Terrain",opacity:1}).addTo(this.map);var l=this.L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",{minZoom:this.mapMinZoom,maxZoom:this.mapMaxZoom,attribution:"ESRI World Terrain",opacity:1}),r=this.L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{minZoom:this.mapMinZoom,maxZoom:this.mapMaxZoom,attribution:"ESRI World Street Map",opacity:1}),o={"Clean Terrain":l,BCC:this.L.tileLayer("https://api.mapbox.com/styles/v1/neiljakeman1000/cljyd364o006701pdgs7ec6qa/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibmVpbGpha2VtYW4xMDAwIiwiYSI6ImNqcGpoenBtdDA2aTczdnBmYjhsNGc5c2oifQ.vqIAnhyoZnnNeBsaNOzQGw",{tileSize:512,zoomOffset:-1,minZoom:this.mapMinZoom,maxZoom:this.mapMaxZoom,attribution:"MapBox BCC",opacity:1}),"Modern Open Street Map":r};this.L.control.layers(o,{},{position:"bottomleft",collapsed:!1}).addTo(this.map),this.map.setView([t,s],i),this.storyFeatureLayerGroup=this.L.layerGroup().addTo(this.map),await this.loadSlides(),await this.loadStoryFrames(),await this.loadFeatures(),this.attachMapEvents(),this.initStoryFeatureLayers(),this.initAllFeaturesLayer(),this.getSlideElements();let a={},n="",h=0,p=document.getElementsByClassName("mapSlide"),d=new IntersectionObserver(function(e){let t=null;e.forEach((e=>{if(!1===e.isIntersecting&&e.target.dataset.slideid==n)for(let e=0;e<p.length;e++)p[e].dataset.slideid==n&&(t=window.scrollY<h&&e>0?p[e-1]:window.scrollY>h&&e+1<p.length?p[e+1]:p[e]);e.intersectionRatio>.4&&e.target.dataset.slideid&&(n=e.target.dataset.slideid,h=window.scrollY),t&&(a[t.dataset.slideid]=setTimeout(function(){t.dataset.isActive="true",this.triggerSlideMapEvents(t.dataset.slideid)}.bind(this),1e3))}))}.bind(this),{threshold:[.8]});for(let e=0;e<this.slideElements.length;e++)d.observe(this.slideElements[e]);d.observe(document.getElementById("filters")),this.d3Intro=new e(this.storyUris,this.L,this.d3),this.d3Intro.homelandsSlide=this.getSlideById(500),this.d3Intro.pathways1Slide=this.getSlideById(600),this.d3Intro.pathways2Slide=this.getSlideById(1032),this.d3Intro.villagerssettlersSlide=this.getSlideById(700),this.d3Intro.linesSlide.push(this.getSlideById(1051)),this.d3Intro.linesSlide.push(this.getSlideById(1052)),this.d3Intro.linesSlide.push(this.getSlideById(1053)),this.d3Intro.linesSlide.push(this.getSlideById(1054)),this.svg=await this.d3Intro.loadD3(this.map)}clearFeatureText(){this.storyFeatureLayerGroup.eachLayer(function(e){let t=e._layers;for(let[e,s]of Object.entries(t)){let t=s.feature.properties.id;e&&this.textFeatures[t]&&null!=s._text&&s.setText(null)}}.bind(this))}attachMapEvents(){this.map.on("zoomend",function(){let e=this.map.getZoom()+4+"px";this.storyFeatureLayerGroup.eachLayer(function(t){if(this.clonedRiverLayer&&t==this.clonedRiverLayer){let s=t._layers;for(let[t,i]of Object.entries(s)){let s=i.feature.properties.id;if(t&&this.textFeatures[s]&&(i.setText(null),this.map.getZoom()>=this.textMinZoomLevel)){let t=this.defaultTextAttributes;t["font-size"]=e,i.setText(this.textFeatures[s].text,{orientation:this.textFeatures[s].orientation,offset:5,center:!0,attributes:t})}}}}.bind(this))}.bind(this))}onEachFeature(e,t){switch((e.properties&&(e.properties.map_text||e.properties.norm_text)||e.properties.Name)&&(e.properties.map_text?(t.bindPopup(e.properties.map_text),e.properties.date_yr&&t.bindPopup(e.properties.map_text+"</br><strong>"+this.mapLookup[e.properties.map_source]+"</stong>")):e.properties.norm_text?(t.bindPopup(e.properties.norm_text),e.properties.date_yr&&t.bindPopup(e.properties.norm_text+"</br><strong>"+this.mapLookup[e.properties.map_source]+"</stong>")):t.bindPopup(e.properties.Name+"</br><strong>Native Land Data API</strong>")),e.geometry.type){case"Point":break;case"MultiPolygon":switch(e.properties.sub_type){case 3:t.setStyle(this.polyBorderStyle);break;case 4:t.setStyle(this.polySettlementStyle);break;case 6:t.setStyle(this.polySeaRouteStyle);break;case 7:t.setStyle(this.polyDescriptiveStyle);break;case 8:t.setStyle(this.polyRiverRouteStyle);break;case 9:t.setStyle(this.polyMiscStyle);break;case 10:t.setStyle(this.polyToponymStyle);break;case 11:switch(e.properties.identity){case 2:t.setStyle(this.polyNativeStyle);break;case 3:t.setStyle(this.polyAnnoStyle);break;default:t.setStyle(this.polyEuroStyle)}}break;case"MultiLineString":switch(e.properties.sub_type){case 3:t.setStyle(this.lineBorderStyle),t.setText(e.properties.norm_text);break;case 5:t.setStyle(this.lineLandRouteStyle),t.setText(e.properties.norm_text);break;case 6:t.setStyle(this.lineSeaRouteStyle),t.setText(e.properties.norm_text);break;case 8:t.setStyle(this.lineRiverRouteStyle);break;case 9:t.setStyle(this.lineMiscStyle),t.setText(e.properties.norm_text);break;case 10:t.setStyle(this.lineToponymStyle),t.setText(e.properties.norm_text)}break;default:t.setStyle(this.defaultLineStyle)}}getStoryFrameBounds(e){for(let t=0;t<this.storyFrames.length;t++)if(this.storyFrames[t].FID==e)return this.storyFrames[t].bounds;return null}async loadStoryFrames(){if(this.storyUris&&this.storyUris.storyFrame){let e=await this.loadShapeFile(this.storyUris.storyFrame);for(let t=0;t<e.features.length;t++){let s=e.features[t],i=this.L.geoJson(s.geometry).getBounds();this.storyFrames.push({FID:s.properties.FID,feature:s,bounds:i})}}}async loadFeatures(){if(this.storyUris&&this.storyUris.lines){let e=await this.loadShapes([this.storyUris.lines]);for(let t=0;t<e.length;t++)this.addFeatureToAllSlides("lines",e[t]);e=await this.loadShapes([this.storyUris.points]);for(let t=0;t<e.length;t++)this.addFeatureToAllSlides("points",e[t]);e=await this.loadShapes([this.storyUris.polys]);for(let t=0;t<e.length;t++)this.addFeatureToAllSlides("polys",e[t]);e=await this.loadShapeFile([this.storyUris.indigenous]);for(let t=0;t<e.features.length;t++)this.addFeatureToAllSlides("indigenous",e.features[t])}}addSubtypeFilter(e,t,s){if(this.exploreFilterControl.sub_type&&this.exploreFilterControl.sub_type.length>=t){const i=this.exploreFilterControl.sub_type[e].indexOf(t);s&&i<0?(this.exploreFilterControl.sub_type[e].push(t),this.totalExploreFiltersApplied+=1):s||(this.exploreFilterControl.sub_type[e].splice(i,1),this.totalExploreFiltersApplied>0&&(this.totalExploreFiltersApplied-=1))}}initExploreFilters(){let e=document.querySelectorAll(this.exploreSelectors.map_filter);if(e)for(let t=0;t<e.length;t++)e[t].addEventListener("click",this.mapFilterClickEvent.bind(this)),e[t].checked=!1;let t=document.querySelectorAll(this.exploreSelectors.explore_filter);if(t)for(let e=0;e<t.length;e++)t[e].addEventListener("click",this.subtypeFilterClickEvent.bind(this)),t[e].checked=!1;let s=document.getElementById(this.exploreSelectors.selectall_features);s&&(s.addEventListener("click",function(e){this.toggleAllFeaturesEnabled=e.target.checked,this.toggleAll(this.exploreSelectors.explore_filter,e.target.checked)}.bind(this)),s.checked=!1);let i=document.getElementById(this.exploreSelectors.selectall_maps);i&&(i.addEventListener("click",function(e){this.toggleAllMapsEnabled=e.target.checked,this.toggleAll(this.exploreSelectors.map_filter,e.target.checked)}.bind(this)),i.checked=!1),this.toggleAllFeaturesEnabled=!1,this.toggleAllMapsEnabled=!1}toggleAll(e,t){let s=document.querySelectorAll(e);Array.prototype.forEach.call(s,(function(e){e.checked!=t&&e.click()})),this.applyExploreFilters(),this.updateFilterCounts()}mapFilterClickEvent(e){let t=e.target.dataset;if(this.updateToggleAllElement(this.exploreSelectors.selectall_maps,e.target.checked),t){const e=parseInt(t.filtervalue),s=this.exploreFilterControl.maps.indexOf(e);s<0?(this.exploreFilterControl.maps.push(e),this.totalMapFiltersApplied+=1):(this.exploreFilterControl.maps.splice(s,1),this.totalMapFiltersApplied>0&&(this.totalMapFiltersApplied-=1)),this.toggleAllFeaturesEnabled||(this.applyExploreFilters(),this.updateFilterCounts())}}updateFilterCounts(){let e=document.getElementById(this.exploreSelectors.explore_counter),t=document.getElementById(this.exploreSelectors.map_counter);if(e){e.innerHTML=this.totalExploreFiltersApplied;let t=document.getElementById(this.exploreSelectors.selectall_features);this.totalExploreFiltersApplied==this.totalExploreFilters&&0==t.checked?t.checked=!0:1==t.checked&&this.totalExploreFiltersApplied<this.totalExploreFilters&&(t.checked=!1)}if(t){t.innerHTML=this.totalMapFiltersApplied;let e=document.getElementById(this.exploreSelectors.selectall_maps);this.totalMapFiltersApplied==this.totalMapFilters&&0==e.checked?e.checked=!0:1==e.checked&&this.totalMapFiltersApplied<this.totalMapFilters&&(e.checked=!1)}}updateToggleAllElement(e,t){if(this.toggleAllFeaturesEnabled&&t!=this.toggleAllFeaturesEnabled){this.toggleAllEnabled=!1;let t=document.getElementById(e);t&&(t.checked=!1)}}subtypeFilterClickEvent(e){let t=e.target.dataset;if(this.updateToggleAllElement(this.exploreSelectors.selectall_features,e.target.checked),t){const s=JSON.parse(t.filtervalue);if(s.sub_type){let t=s.sub_type;for(let i=0;i<s.identity.length;i++)this.addSubtypeFilter(t,s.identity[i],e.target.checked)}this.toggleAllFeaturesEnabled||(this.applyExploreFilters(),this.updateFilterCounts())}}applyExploreFilters(){this.storyFeatureLayerGroup.clearLayers();let e=[],t=[];if(console.log(this.exploreFilterControl.sub_type.length),this.exploreFeatures){let e=!1;if(!this.toggleAllFeaturesEnabled){let t=document.querySelectorAll(this.exploreSelectors.explore_filter);if(t)for(let s=0;s<t.length;s++)if(t[s].checked){e=!0;break}}this.toggleAllFeaturesEnabled||!e?t=this.exploreFeatures:this.exploreFeatures.forEach(function(e){let s=-1;e.properties&&this.exploreFilterControl.sub_type[0].length>0?s=0:e.properties&&e.properties.sub_type&&(s=e.properties.sub_type),s>=0&&e.properties&&this.exploreFilterControl.sub_type.length>s&&(e.properties.identity&&this.exploreFilterControl.sub_type[s].indexOf(e.properties.identity)>-1||this.exploreFilterControl.sub_type[s].indexOf(0)>-1)&&t.push(e)}.bind(this))}this.toggleAllMapsEnabled?e=t:0!=this.exploreFilterControl.maps.length||this.toggleAllMapsEnabled?this.exploreFilterControl.maps.length>0&&!this.toggleAllMapsEnabled&&t.forEach(function(t){t.properties&&t.properties.map_source&&this.exploreFilterControl.maps.indexOf(t.properties.map_source)>-1&&e.push(t)}.bind(this)):e=[],e&&e.length>0&&(this.exploreFeaturesLayer=this.L.geoJSON(e,{pointToLayer:this.pointToLayer.bind(this),onEachFeature:this.onEachFeature.bind(this)}),this.storyFeatureLayerGroup.addLayer(this.exploreFeaturesLayer))}filterFeature(e,t){let s=!1;for(const[i,l]of Object.entries(t)){if("id"==i&&i in e.properties&&l.includes(e.properties.id)){s=!0;break}if(!(i in e.properties)||!l.includes(e.properties[i])){s=!1;break}s=!0}return s}includeFeature(e,t,s){let i=!1;switch(t){case"lines":s.lines&&(s.lines.includes&&(i=this.filterFeature(e,s.lines.includes)),s.lines.excludes&&!0===i&&(i=!this.filterFeature(e,s.lines.excludes)));break;case"polys":s.polys&&(s.polys.includes&&(i=this.filterFeature(e,s.polys.includes)),s.polys.excludes&&!0===i&&(i=!this.filterFeature(e,s.polys.excludes)));break;case"points":s.points&&(s.points.includes&&(i=this.filterFeature(e,s.points.includes)),s.points.excludes&&!0===i&&(i=!this.filterFeature(e,s.points.excludes)));break;case"indigenous":s.indigenous&&(i=this.filterFeature(e,s.indigenous.includes))}return i}addFeatureToAllSlides(e,t){for(let s=0;s<this.slides.length;s++){let i=this.slides[s];this.includeFeature(t,e,i)&&i.features.push(t)}t&&t.properties&&t.properties.sub_type&&this.exploreFeatureSubtypes.includes(t.properties.sub_type)&&this.exploreFeatures.push(t)}loadExploreLayer(){}}(storyURIs,L,d3).initMap(startLat,startLng,startZoom)})();